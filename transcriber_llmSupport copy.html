<!-- File: transcriber.html — Local (no server) voice + system audio transcription with Soniox + Diarization + OpenAI Summary per session
     Additions in this version:
       • Student Picker modal BEFORE recording (choose/create student)
       • Students panel (list + add student, open per-student page)
       • Sessions saved with studentId + shown in History
       • currentStudent pill showing who you’re recording for
       • Scroll lock fix: page doesn’t scroll while modal is open; lists in modal are scrollable
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Local Transcriber — Soniox (Mic + System/Tab Audio) + Diarization + OpenAI Summary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b0c10; --panel: #11141a; --muted: #667085; --text: #e6e6e6; --accent: #6ee7ff; --danger: #ff6b6b; --ok: #22c55e; --warn: #f59e0b;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
    .wrap{max-width:920px;margin:auto;padding:24px}
    .card{background:var(--panel);border:1px solid #1f2430;border-radius:16px;padding:20px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .grow{flex:1}
    label{font-size:14px;color:var(--muted);}
    input[type="text"], input[type="password"]{
      width:100%;padding:12px 14px;border-radius:12px;border:1px solid #262b36;background:#0d0f14;color:#e6e6e6;
    }
    button{
      border:0;border-radius:14px;padding:14px 18px;font-weight:700;cursor:pointer;
      background:#1a90ff;color:#fff;transition:transform .02s ease;
    }
    button:active{transform:translateY(1px)}
    button.secondary{background:#2b323f}
    button.danger{background:var(--danger)}
    button.ok{background:var(--ok);color:#0a0a0a}
    .big{font-size:18px;padding:18px 22px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#1a2130;color:#cbd5e1;font-size:12px}
    .statusdot{width:10px;height:10px;border-radius:50%;background:#475569;display:inline-block}
    .statusdot.live{background:#22c55e;box-shadow:0 0 0 0 rgba(34,197,94,.8);animation:pulse 1.4s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(34,197,94,.6)}70%{box-shadow:0 0 0 10px rgba(34,197,94,0)}100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}}
    .transcript{min-height:160px;white-space:pre-wrap;background:#0d0f14;border:1px solid #1f2430;border-radius:14px;padding:16px}
    .sub{color:#94a3b8;font-size:13px}
    .note{background:#0e121a;border:1px dashed #223049;border-radius:12px;padding:12px;font-size:13px;color:#b8c3cf}
    .warn{color:var(--warn)}
    .history{display:grid;gap:10px}
    .hist-item{background:#0d1017;border:1px solid #1f2430;border-radius:12px;padding:12px}
    .small{font-size:12px}
    .sliders{display:flex;gap:16px;align-items:center}
    input[type="range"]{width:180px}

    /* ===== simple modal (shared) ===== */
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999;overflow:auto}
    .modal{max-width:640px;width:100%;background:var(--panel);border:1px solid #1f2430;border-radius:16px;padding:18px;max-height:90vh;display:flex;flex-direction:column}
    .list{display:grid;gap:8px;margin:10px 0}
    .list-item{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid #1f2430;border-radius:10px;background:#0d0f14}
    .muted{color:#94a3b8}
    .hr{height:1px;background:#1f2430;margin:10px 0}

    /* Scroll only modal, not page */
    body.modal-open{overflow:hidden}
    #spList, #stList{flex:1;min-height:0;max-height:60vh;overflow-y:auto;overscroll-behavior:contain;padding-right:6px}
  </style>
</head>
<body>
<div class="wrap">
  <h2 style="margin:0 0 12px 0;">Local Transcriber</h2>
  <div class="sub" style="margin-bottom:18px">Mic + (optional) system/tab audio → real-time Soniox transcription with speaker diarization. Local-only UI; only Soniox/OpenAI APIs are contacted.</div>

  <!-- SONIOX KEY PANEL -->
  <div class="card" id="keyPanel" style="display:none; margin-bottom:16px">
    <div class="row">
      <div class="grow">
        <label for="apiKey">SONIOX API Key</label>
        <input id="apiKey" type="password" placeholder="soniox_************************" autocomplete="off" />
        <div class="sub">Stored only in your browser (<code>localStorage</code>).</div>
      </div>
      <div>
        <button id="saveKeyBtn" class="big ok">Save Key</button>
      </div>
    </div>
  </div>

  <!-- OPENAI KEY PANEL (mirrors Soniox UI) -->
  <div class="card" id="openaiKeyPanel" style="display:none; margin-bottom:16px">
    <div class="row">
      <div class="grow">
        <label for="openaiApiKey">OPENAI API Key</label>
        <input id="openaiApiKey" type="password" placeholder="sk-************************" autocomplete="off" />
        <div class="sub">Stored only in your browser (<code>localStorage</code>).</div>
      </div>
      <div>
        <button id="saveOpenAiKeyBtn" class="big ok">Save OpenAI Key</button>
      </div>
    </div>
  </div>

  <!-- CONTROLS -->
  <div class="card" style="margin-bottom:16px">
    <div class="row" style="justify-content:space-between;margin-bottom:10px">
      <div class="row">
        <span class="pill"><span id="statusDot" class="statusdot"></span><span id="statusText">idle</span></span>
      </div>
      <div class="row small">
        <span id="currentModel" class="pill">model: stt-rt-preview</span>
        <span id="langId" class="pill">multilingual: on</span>
        <span class="pill"><span>speakers:</span><span id="speakersCount">0</span></span>
        <span class="pill"><span>sessions:</span><span id="sessionCount">0</span></span>
        <span id="currentStudentPill" class="pill">student: —</span>
      </div>
    </div>

    <div class="row" style="margin-bottom:10px">
      <div class="row">
        <input id="captureSystem" type="checkbox" />
        <label for="captureSystem" style="margin-left:6px">Capture browser/system audio (tab/system sound)</label>
      </div>
      <div class="row sliders">
        <label>Mic gain</label><input id="micGain" type="range" min="0" max="200" value="100">
        <label>System gain</label><input id="sysGain" type="range" min="0" max="200" value="100">
      </div>
      <div class="grow"></div>
      <div class="row">
        <button id="startBtn" class="big">Start Transcribing</button>
        <button id="stopBtn" class="big danger" disabled>Stop</button>
        <button id="cancelBtn" class="big secondary" disabled>Cancel</button>
      </div>
    </div>

    <div class="note" id="sysNote" style="display:none;margin-top:8px">
      Pick <b>This Tab</b> + enable <b>Share tab audio</b>, or pick <b>Entire screen</b> + enable <b>Share system audio</b> (Windows/ChromeOS).
      macOS typically allows <i>tab audio</i> only. If no system audio track is detected, you'll see a warning.
    </div>

    <div id="systemWarn" class="sub warn" style="display:none;margin-top:8px"></div>

    <div class="row" style="margin-top:12px">
      <button id="setKeyLink" class="secondary">Set / Change Soniox Key</button>
      <button id="setOpenAiKeyLink" class="secondary">Set / Change OpenAI Key</button>
      <button id="studentsBtn" class="secondary">Students</button>
      <button id="clearAllBtn" class="secondary">Clear All Sessions</button>
    </div>
  </div>

  <!-- LIVE + FINAL -->
  <div class="card" style="margin-bottom:16px">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:10px">
      <div class="row"><strong>Live Transcript</strong></div>
      <div class="small sub" id="timer">00:00</div>
    </div>
    <div id="live" class="transcript" aria-live="polite"></div>
    <div class="sub" style="margin-top:10px">Final (words locked):</div>
    <div id="final" class="transcript"></div>
  </div>

  <!-- HISTORY -->
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:10px">
      <strong>Session History</strong>
      <span class="small sub">Saved locally</span>
    </div>
    <div id="history" class="history"></div>
  </div>

  <p class="sub" style="margin-top:18px">
    Tips: Chrome/Edge give best system-audio capture. Soniox auto-detects languages (English + Arabic). "Summary" uses OpenAI to generate a lesson-note Markdown.
  </p>
</div>

<!-- ===== Student Picker Modal (before recording) ===== -->
<div id="studentPickerBack" class="modal-back" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">Choose Student</h3>
      <button id="spClose" class="secondary">Close</button>
    </div>
    <div class="sub">Pick who this recording belongs to. You can add a new student below.</div>

    <div id="spList" class="list" style="margin-top:10px"></div>

    <div class="hr"></div>
    <label for="spNewName">+ New student</label>
    <div class="row">
      <input id="spNewName" type="text" placeholder="Type a name, e.g., Ali" />
      <button id="spAdd" class="ok">Add</button>
    </div>

    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button id="spCancel" class="secondary">Cancel</button>
      <button id="spConfirm" class="big">Continue & Start</button>
    </div>
  </div>
</div>

<!-- ===== Students Panel (list + add) ===== -->
<div id="studentsBack" class="modal-back" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">Students</h3>
      <button id="stClose" class="secondary">Close</button>
    </div>
    <div id="stList" class="list" style="margin-top:10px"></div>
    <div class="hr"></div>
    <label for="stNewName">+ New student</label>
    <div class="row">
      <input id="stNewName" type="text" placeholder="Type a name, e.g., Samir" />
      <button id="stAdd" class="ok">Add</button>
    </div>
  </div>
</div>

<script type="module">
  import { SonioxClient } from 'https://unpkg.com/@soniox/speech-to-text-web?module';

  // ===== DOM =====
  const keyPanel = document.getElementById('keyPanel');
  const apiKeyInput = document.getElementById('apiKey');
  const saveKeyBtn = document.getElementById('saveKeyBtn');
  const setKeyLink = document.getElementById('setKeyLink');

  const openaiKeyPanel = document.getElementById('openaiKeyPanel');
  const openaiApiKeyInput = document.getElementById('openaiApiKey');
  const saveOpenAiKeyBtn = document.getElementById('saveOpenAiKeyBtn');
  const setOpenAiKeyLink = document.getElementById('setOpenAiKeyLink');

  const captureSystem = document.getElementById('captureSystem');
  const sysNote = document.getElementById('sysNote');
  const sysWarn = document.getElementById('systemWarn');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const statusDot = document.getElementById('statusDot');
  const statusText = document.getElementById('statusText');
  const liveEl = document.getElementById('live');
  const finalEl = document.getElementById('final');
  const timerEl = document.getElementById('timer');
  const historyEl = document.getElementById('history');
  const sessionCountEl = document.getElementById('sessionCount');
  const speakersCountEl = document.getElementById('speakersCount');
  const micGainEl = document.getElementById('micGain');
  const sysGainEl = document.getElementById('sysGain');
  const currentStudentPill = document.getElementById('currentStudentPill');
  const studentsBtn = document.getElementById('studentsBtn');

  // Student Picker modal
  const spBack = document.getElementById('studentPickerBack');
  const spList = document.getElementById('spList');
  const spNewName = document.getElementById('spNewName');
  const spAdd = document.getElementById('spAdd');
  const spConfirm = document.getElementById('spConfirm');
  const spCancel = document.getElementById('spCancel');
  const spClose = document.getElementById('spClose');

  // Students panel modal
  const stBack = document.getElementById('studentsBack');
  const stList = document.getElementById('stList');
  const stNewName = document.getElementById('stNewName');
  const stAdd = document.getElementById('stAdd');
  const stClose = document.getElementById('stClose');

  // ===== Scroll lock helpers =====
  function lockBodyScroll(){ document.body.classList.add('modal-open'); }
  function unlockBodyScroll(){ document.body.classList.remove('modal-open'); }
  function anyModalOpen(){ return (spBack.style.display==='flex') || (stBack.style.display==='flex'); }

  // extra guard to stop scroll on backdrop (allow inner list to scroll)
  ['wheel','touchmove'].forEach(evt => {
    [spBack, stBack].forEach(el => {
      el.addEventListener(evt, (e) => {
        if (e.target === el) e.preventDefault();
      }, { passive:false });
    });
  });

  // ===== STATE =====
  let soniox = null;
  let audioCtx = null;
  let micStream = null;
  let displayStream = null;
  let mixedStream = null;
  let micGainNode = null;
  let sysGainNode = null;
  let destNode = null;
  let running = false;
  let startedAt = 0;
  let timerInt = null;

  // Students
  let currentStudentId = localStorage.getItem('currentStudentId') || '';
  function uid(){ return Math.random().toString(36).slice(2,8) + '-' + Date.now().toString(36); }
  function cleanName(n){ return (n||'').trim().replace(/\s+/g,' ').slice(0,64); }

  function getStudents(){
    try { return JSON.parse(localStorage.getItem('students')||'[]'); } catch { return []; }
  }
  function saveStudents(arr){
    localStorage.setItem('students', JSON.stringify(arr));
  }
  function addStudent(name){
    const nm = cleanName(name);
    if (!nm) return null;
    const arr = getStudents();
    const exists = arr.find(s => s.name.toLowerCase() === nm.toLowerCase());
    if (exists) return exists; // reuse
    const s = { id: 'stu-' + uid(), name: nm, createdAt: new Date().toISOString() };
    arr.push(s); saveStudents(arr);
    return s;
  }
  function getStudentById(id){
    return getStudents().find(s => s.id === id) || null;
  }
  function setCurrentStudent(id){
    currentStudentId = id || '';
    localStorage.setItem('currentStudentId', currentStudentId);
    const s = getStudentById(currentStudentId);
    currentStudentPill.textContent = 'student: ' + (s ? s.name : '—');
  }
  // initialize pill
  setCurrentStudent(currentStudentId);

  // text assembly with diarization
  let finalSegments = [];  // [{label: 'Speaker 1', text: '...'}]
  let lastRenderedLive = '';
  const speakerMap = new Map(); // numericSpeakerId -> 'Speaker N'
  function resetSpeakersUI(){ speakersCountEl.textContent = '0'; }
  function getSpeakerId(tok){
    return tok?.speaker ?? tok?.speaker_id ?? tok?.spk ?? tok?.spk_id ?? tok?.channel ?? 0;
  }
  function labelForSpeaker(id){
    const key = String(id);
    if (!speakerMap.has(key)){
      const nextNum = speakerMap.size + 1;
      speakerMap.set(key, `Speaker ${nextNum}`);
      speakersCountEl.textContent = String(speakerMap.size);
    }
    return speakerMap.get(key);
  }
  function renderSegments(segments){
    return segments.map(s => `${s.label}: ${s.text}`).join('\n');
  }
  function cloneSegments(){ return finalSegments.map(s => ({label:s.label, text:s.text})); }

  // ===== INIT =====
  function ensureKeyPanelVisibility() {
    const hasKey = !!localStorage.getItem('soniox_api_key');
    keyPanel.style.display = hasKey ? 'none' : 'block';
  }
  function ensureOpenAIKeyPanelVisibility(){
    const has = !!localStorage.getItem('openai_api_key');
    openaiKeyPanel.style.display = has ? 'none' : 'block';
  }
  ensureKeyPanelVisibility();
  ensureOpenAIKeyPanelVisibility();

  setKeyLink.onclick = () => { keyPanel.style.display = 'block'; apiKeyInput.focus(); };
  saveKeyBtn.onclick = () => {
    const k = (apiKeyInput.value || '').trim();
    if (!k) return alert('Enter a valid SONIOX API key.');
    localStorage.setItem('soniox_api_key', k);
    apiKeyInput.value = '';
    keyPanel.style.display = 'none';
    alert('Soniox key saved locally.');
  };

  setOpenAiKeyLink.onclick = () => { openaiKeyPanel.style.display = 'block'; openaiApiKeyInput.focus(); };
  saveOpenAiKeyBtn.onclick = () => {
    const k = (openaiApiKeyInput.value || '').trim();
    if (!k) return alert('Enter a valid OpenAI API key.');
    localStorage.setItem('openai_api_key', k);
    openaiApiKeyInput.value = '';
    openaiKeyPanel.style.display = 'none';
    alert('OpenAI key saved locally.');
  };
  function getOpenAIKey() {
    const k = localStorage.getItem('openai_api_key');
    if (!k) {
      openaiKeyPanel.style.display = 'block';
      openaiApiKeyInput.focus();
      throw new Error('OpenAI key not set.');
    }
    return k;
  }

  captureSystem.addEventListener('change', () => {
    sysNote.style.display = captureSystem.checked ? 'block' : 'none';
  });

  micGainEl.addEventListener('input', () => { if (micGainNode) micGainNode.gain.value = Number(micGainEl.value)/100; });
  sysGainEl.addEventListener('input', () => { if (sysGainNode) sysGainNode.gain.value = Number(sysGainEl.value)/100; });

  // ===== STATUS =====
  function setStatus(text, mode='idle'){
    statusText.textContent = text;
    statusDot.className = 'statusdot' + (mode==='live' ? ' live' : mode==='busy' ? ' busy' : mode==='err' ? ' err' : '');
  }
  function setButtonsRecordingState(isRecording){
    if (isRecording){
      startBtn.textContent = 'Recording…';
      startBtn.disabled = true;
      stopBtn.disabled = false;
      cancelBtn.disabled = false;
    } else {
      startBtn.textContent = 'Start Transcribing';
      startBtn.disabled = false;
      stopBtn.disabled = true;
      cancelBtn.disabled = true;
    }
  }
  function fmtTime(ms){
    const s = Math.floor(ms/1000);
    const mm = String(Math.floor(s/60)).padStart(2,'0');
    const ss = String(s%60).padStart(2,'0');
    return `${mm}:${ss}`;
  }
  function startTimer(){
    startedAt = Date.now();
    timerInt = setInterval(()=>{ timerEl.textContent = fmtTime(Date.now()-startedAt); }, 200);
  }
  function stopTimer(){
    clearInterval(timerInt);
    timerEl.textContent = '00:00';
  }

  // ===== AUDIO (mix mic + system/tab) =====
  async function buildMixedStream(wantSystemAudio){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 48000 });
    destNode = audioCtx.createMediaStreamDestination();

    // mic — disable echoCancellation to avoid AEC killing system audio when mixing
    micStream = await navigator.mediaDevices.getUserMedia({
      audio: { echoCancellation:false, noiseSuppression:true, autoGainControl:true },
      video:false
    });
    const micSrc = audioCtx.createMediaStreamSource(micStream);
    micGainNode = audioCtx.createGain(); micGainNode.gain.value = Number(micGainEl.value)/100;
    micSrc.connect(micGainNode).connect(destNode);

    // optional system/tab
    sysWarn.style.display = 'none';
    if (wantSystemAudio) {
      try {
        displayStream = await navigator.mediaDevices.getDisplayMedia({
          video:true,
          audio: { systemAudio: 'include' } // some browsers ignore; harmless
        });
        const hasAudio = displayStream.getAudioTracks().length > 0;
        if (!hasAudio) {
          sysWarn.textContent = 'No system/tab audio track detected. Enable "Share tab audio" (or "Share system audio" on Windows).';
          sysWarn.style.display = 'block';
        } else {
          const sysSrc = audioCtx.createMediaStreamSource(displayStream);
          sysGainNode = audioCtx.createGain(); sysGainNode.gain.value = Number(sysGainEl.value)/100;
          sysSrc.connect(sysGainNode).connect(destNode);
        }

        // if user stops screen-share from Chrome UI
        const vTracks = displayStream.getVideoTracks();
        if (vTracks[0]) vTracks[0].addEventListener('ended', () => {
          console.warn('Screen share ended by user.');
          if (running) stopTranscription();
        });
      } catch(e){
        console.warn('Display media not granted, continuing mic-only.', e);
        sysWarn.textContent = 'Screen share permission denied. Transcribing microphone only.';
        sysWarn.style.display = 'block';
      }
    }

    mixedStream = destNode.stream;
    return mixedStream;
  }
  function stopAllTracks(){
    [micStream, displayStream].forEach(s => {
      if (!s) return;
      s.getTracks().forEach(t => t.stop());
    });
    micStream = displayStream = null;
    mixedStream = null;
    if (audioCtx) { audioCtx.close().catch(()=>{}); audioCtx = null; }
  }

  // ===== SESSIONS (localStorage) =====
  function saveSession(text, durMs){
    const id = `session-${Date.now()}`;
    const session = {
      id,
      timestamp: new Date().toLocaleString(),
      duration_ms: durMs,
      transcript: text,
      studentId: currentStudentId || ''   // tag to student
    };
    localStorage.setItem(id, JSON.stringify(session));

    // also index under the student for quick filtering
    if (session.studentId){
      const key = `studentSessions-${session.studentId}`;
      const list = JSON.parse(localStorage.getItem(key) || '[]');
      list.unshift(id);
      localStorage.setItem(key, JSON.stringify(list));
    }

    renderHistory();
  }
  function loadSessions(){
    const out = [];
    for (let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i);
      if (k && k.startsWith('session-')) {
        try {
          const obj = JSON.parse(localStorage.getItem(k) || '{}');
          if (!obj.id) obj.id = k;
          out.push(obj);
        } catch {}
      }
    }
    out.sort((a, b) => {
      const tb = Number(String(b?.id ?? '').replace('session-',''));
      const ta = Number(String(a?.id ?? '').replace('session-',''));
      return (isNaN(tb) ? 0 : tb) - (isNaN(ta) ? 0 : ta);
    });
    return out;
  }

  // ===== TOKEN FILTERS =====
  function isDisplayableTokenText(txt){
    if (!txt) return false;
    const t = String(txt);
    if (!t.trim()) return false;
    const low = t.trim().toLowerCase();
    if (low === 'end' || low === 'endpoint') return false;
    if (/^<[^>]+>$/.test(t)) return false;
    return true;
  }

  // ===== TRANSCRIPTION (with diarization grouping) =====
  function resetText(){
    finalSegments = [];
    lastRenderedLive = '';
    speakerMap.clear(); resetSpeakersUI();
    liveEl.textContent = '';
    finalEl.textContent = '';
  }

  function appendFinalToken(tok){
    const txt = String(tok.text || '');
    if (!isDisplayableTokenText(txt)) return;
    const label = labelForSpeaker(getSpeakerId(tok));
    if (finalSegments.length === 0 || finalSegments[finalSegments.length - 1].label !== label){
      finalSegments.push({ label, text: txt });
    } else {
      finalSegments[finalSegments.length - 1].text += txt;
    }
  }

  function buildLiveFromNonfinal(tokens){
    const copy = cloneSegments();
    tokens.forEach(tok => {
      const txt = String(tok.text || '');
      if (!isDisplayableTokenText(txt)) return;
      const label = labelForSpeaker(getSpeakerId(tok));
      if (copy.length === 0 || copy[copy.length - 1].label !== label){
        copy.push({ label, text: txt });
      } else {
        copy[copy.length - 1].text += txt;
      }
    });
    return renderSegments(copy);
  }

  // ======= Student Picker flow =======
  function openStudentPicker(){
    // build list
    spList.innerHTML = '';
    const students = getStudents();
    if (students.length === 0){
      const p = document.createElement('div');
      p.className = 'muted';
      p.textContent = 'No students yet. Add one below.';
      spList.appendChild(p);
    } else {
      students.forEach(s => {
        const id = 'sp-' + s.id;
        const div = document.createElement('label');
        div.className = 'list-item';
        div.innerHTML = `
          <input type="radio" name="spick" value="${s.id}" id="${id}">
          <div class="grow">
            <div><strong>${s.name}</strong></div>
            <div class="small muted">${s.id}</div>
          </div>
        `;
        spList.appendChild(div);
      });
      // preselect last used
      const pre = currentStudentId && document.querySelector(`input[name="spick"][value="${currentStudentId}"]`);
      (pre || document.querySelector('input[name="spick"]'))?.setAttribute('checked','checked');
    }
    spNewName.value = '';
    spBack.style.display = 'flex';
    spNewName.placeholder = 'Type a name, e.g., Ali';
    lockBodyScroll(); // prevent page scroll while modal open
  }
  function closeStudentPicker(){
    spBack.style.display = 'none';
    if (!anyModalOpen()) unlockBodyScroll();
  }

  spAdd.onclick = () => {
    const nm = cleanName(spNewName.value);
    if (!nm) { alert('Type a student name.'); return; }
    const s = addStudent(nm);
    if (!s) return;
    // rebuild list & preselect new
    openStudentPicker();
    const pre = document.querySelector(`input[name="spick"][value="${s.id}"]`);
    pre?.setAttribute('checked','checked');
  };
  spConfirm.onclick = async () => {
    const sel = document.querySelector('input[name="spick"]:checked');
    if (sel) {
      setCurrentStudent(sel.value);
      closeStudentPicker();
      await startTranscription(); // proceed
      return;
    }
    const nm = cleanName(spNewName.value);
    if (nm){
      const s = addStudent(nm);
      if (s){ setCurrentStudent(s.id); closeStudentPicker(); await startTranscription(); }
    } else {
      alert('Choose or add a student first.');
    }
  };
  spCancel.onclick = closeStudentPicker;
  spClose.onclick = closeStudentPicker;

  // ===== Students panel (list + add) =====
  function openStudentsPanel(){
    stList.innerHTML = '';
    const arr = getStudents();
    if (arr.length === 0){
      const p = document.createElement('div');
      p.className = 'muted';
      p.textContent = 'No students yet.';
      stList.appendChild(p);
    } else {
      arr.forEach(s => {
        // count sessions (fast path if indexed)
        const key = `studentSessions-${s.id}`;
        let cnt = 0;
        try { cnt = (JSON.parse(localStorage.getItem(key)||'[]')||[]).length; } catch {}
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
          <div class="grow">
            <div><strong>${s.name}</strong></div>
            <div class="small muted">${cnt} session${cnt===1?'':'s'} • ${s.id}</div>
          </div>
          <button data-act="open" data-id="${s.id}" class="secondary">Open</button>
          <button data-act="set" data-id="${s.id}" class="secondary">Set as current</button>
        `;
        stList.appendChild(div);
      });
    }
    stNewName.value = '';
    stBack.style.display = 'flex';
    lockBodyScroll(); // prevent page scroll while modal open
  }
  function closeStudentsPanel(){
    stBack.style.display = 'none';
    if (!anyModalOpen()) unlockBodyScroll();
  }

  stAdd.onclick = () => {
    const nm = cleanName(stNewName.value);
    if (!nm) { alert('Type a student name.'); return; }
    const s = addStudent(nm);
    if (s){ setCurrentStudent(s.id); openStudentsPanel(); }
  };
  stClose.onclick = closeStudentsPanel;
  studentsBtn.onclick = openStudentsPanel;

  // Clicks in Students list
  stList.addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const id = btn.getAttribute('data-id');
    const act = btn.getAttribute('data-act');
    if (act === 'open') {
      location.href = 'student.html?id=' + encodeURIComponent(id);
      return;
    }
    if (act === 'set') {
      setCurrentStudent(id);
      alert('Current student set to: ' + (getStudentById(id)?.name || id));
      openStudentsPanel();
    }
  });

  // ===== TRANSCRIBE LIFECYCLE =====
  async function startTranscription(){
    const apiKey = localStorage.getItem('soniox_api_key');
    if (!apiKey) { keyPanel.style.display='block'; apiKeyInput.focus(); return alert('Set your Soniox API key first.'); }
    // Ensure a student is selected
    if (!currentStudentId){
      openStudentPicker();
      return;
    }

    setStatus('requesting permissions…', 'busy');
    resetText();
    setButtonsRecordingState(false); // during setup

    try {
      const stream = await buildMixedStream(captureSystem.checked);
      setStatus('connecting…', 'busy');

      soniox = new SonioxClient({
        apiKey: () => localStorage.getItem('soniox_api_key'),
        onStarted: () => {
          running = true;
          setStatus('LIVE', 'live');
          setButtonsRecordingState(true);
          startTimer();
        },
        onFinished: () => {
          running = false;
          setStatus('finished');
          stopTimer();
          saveSession((finalEl.textContent || '').trim(), Date.now() - startedAt);
          stopAllTracks();
          setButtonsRecordingState(false);
        },
        onError: (status, message) => {
          console.error('Soniox error:', status, message);
          setStatus(message || status, 'err');
          running = false;
          stopTimer();
          stopAllTracks();
          setButtonsRecordingState(false);
          if (status === 'api_error' && /401|unauthorized/i.test(String(message))) {
            alert('Invalid Soniox API key. Please set a valid key.');
            keyPanel.style.display='block';
          }
        }
      });

      await soniox.start({
        model: 'stt-rt-preview',
        stream,
        enableEndpointDetection: false,
        enableLanguageIdentification: true,
        languageHints: ['en','ar'],
        enableSpeakerDiarization: true,
        onPartialResult: (result) => {
          try {
            const tokens = Array.isArray(result?.tokens) ? result.tokens : [];
            for (const t of tokens) { if (t?.is_final) appendFinalToken(t); }
            finalEl.textContent = renderSegments(finalSegments);

            const nonfinal = tokens.filter(t => !t?.is_final);
            const liveNow = buildLiveFromNonfinal(nonfinal);
            if (liveNow !== lastRenderedLive){
              lastRenderedLive = liveNow;
              liveEl.textContent = liveNow;
            }
          } catch (e) {
            console.warn('onPartialResult parse issue:', e);
          }
        }
      });

    } catch (e) {
      console.error(e);
      if (String(e).includes('NotAllowedError')) {
        setStatus('mic/screen permission denied', 'err');
        alert('Permission denied. Enable microphone (and screen audio if selected).');
      } else if (String(e).includes('NotFoundError')) {
        setStatus('no audio device found', 'err');
        alert('No microphone found.');
      } else {
        setStatus('failed to start', 'err');
        alert('Failed to start. See console for details.');
      }
      stopAllTracks();
      setButtonsRecordingState(false);
    }
  }

  async function stopTranscription(){
    if (!running || !soniox) return;
    setStatus('stopping…', 'busy');
    stopBtn.disabled = true;
    try {
      await soniox.stop(); // waits for finalization
    } catch (e) {
      console.warn('stop error', e);
      stopTimer();
      saveSession((finalEl.textContent || '').trim(), Date.now() - startedAt);
      stopAllTracks();
      setStatus('finished');
      setButtonsRecordingState(false);
    }
  }
  function cancelTranscription(){
    if (!running || !soniox) return;
    setStatus('cancelling…', 'busy');
    cancelBtn.disabled = true;
    try { soniox.cancel(); } catch {}
    running = false;
    stopTimer();
    stopAllTracks();
    setStatus('cancelled');
    setButtonsRecordingState(false);
  }

  // Start opens picker first
  startBtn.onclick = () => openStudentPicker();
  stopBtn.onclick = stopTranscription;
  cancelBtn.onclick = cancelTranscription;

  // Heads-up if the environment blocks mic from file://
  if (!('mediaDevices' in navigator)) {
    setStatus('your browser blocked mic (secure context required)', 'err');
  }

  // ====== OPENAI SUMMARY CONFIG ======
  const OPENAI_MODEL = 'gpt-5-mini';
  const SUMMARY_INSTRUCTIONS = `You are an expert Arabic–English lesson summarizer. Output ONLY Markdown with the sections requested.`;

  const SUMMARY_PROMPT = `I will give you a transcript of an Arabic–English language lesson.
Please create a structured summary in the style of a lesson note.
The summary must include:

Vocabulary & Phrases table (Arabic, meaning, example sentence).

Cultural Notes (if any appear).

Grammar Highlights (rules, corrections, examples).

Key Expressions & Functional Language (important ready-to-use phrases grouped by function: asking, agreeing, disagreeing, giving opinions, etc.).

Practice Sentences or a Mini-Dialogue using the new vocabulary and grammar in natural context.

Make it clear, organized, and reusable for teaching. Use Markdown headings and tables.`;

  async function openaiSummarize(markdownPrompt) {
    const key = getOpenAIKey();
    const resp = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + key },
      body: JSON.stringify({
        model: OPENAI_MODEL,
        temperature: 1,
        messages: [
          { role: 'system', content: SUMMARY_INSTRUCTIONS },
          { role: 'user', content: markdownPrompt }
        ]
      })
    });
    const data = await resp.json();
    if (!resp.ok) { throw new Error(data?.error?.message || 'OpenAI API error'); }
    const text = data?.choices?.[0]?.message?.content?.trim() || '';
    return text;
  }

  function buildSummaryUserPrompt(transcript) {
    return `${SUMMARY_PROMPT}\n\n---\nTRANSCRIPT:\n${transcript}`;
  }

  async function summarizeSessionById(sessionId, btnElem) {
    const raw = localStorage.getItem(sessionId);
    if (!raw) return alert('Session not found.');
    const s = JSON.parse(raw);

    if (s.summary_md && !confirm('A summary already exists. Regenerate it?')) return;

    try {
      if (btnElem) { btnElem.disabled = true; btnElem.textContent = 'Summarizing…'; }
      const userPrompt = buildSummaryUserPrompt(s.transcript || '');
      const md = await openaiSummarize(userPrompt);
      s.summary_md = md || '';
      localStorage.setItem(sessionId, JSON.stringify(s));
      renderHistory();
      const pre = document.getElementById('s-' + sessionId);
      if (pre) { pre.textContent = s.summary_md; pre.style.display = 'block'; }
      alert('Summary ready.');
    } catch (e) {
      console.error(e);
      alert('Failed to summarize: ' + e.message);
    } finally {
      if (btnElem) { btnElem.disabled = false; btnElem.textContent = 'Refresh'; }
    }
  }

  // ===== HISTORY (with Summary controls) + show student =====
  function renderHistory(){
    const sessions = loadSessions();
    sessionCountEl.textContent = sessions.length;
    historyEl.innerHTML = '';
    sessions.forEach(s => {
      const hasSummary = !!s.summary_md;
      const stu = s.studentId ? (getStudentById(s.studentId)?.name || 'Unknown') : '—';
      const studentLine = s.studentId
        ? `<a href="student.html?id=${s.studentId}" class="small">student: ${stu}</a>`
        : `<span class="sub small">student: —</span>`;
      const div = document.createElement('div');
      div.className = 'hist-item';
      div.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div>
            <div><strong>${s.timestamp}</strong></div>
            <div class="sub small">${fmtTime(s.duration_ms || 0)} — ${s.id}</div>
            <div class="sub small">${studentLine}</div>
          </div>
          <div class="row">
            <button data-act="view" data-id="${s.id}" class="secondary">View</button>
            <button data-act="copy" data-id="${s.id}" class="secondary">Copy</button>
            <button data-act="dl" data-id="${s.id}" class="secondary">Export .txt</button>
            <button data-act="del" data-id="${s.id}" class="danger">Delete</button>
          </div>
        </div>

        <div class="row" style="margin-top:8px; justify-content:flex-end; gap:8px">
          <span class="small sub" style="margin-right:auto">Summary:</span>
          <button data-act="sum" data-id="${s.id}" class="secondary">${hasSummary ? 'Refresh' : 'Summary'}</button>
          <button data-act="sumview" data-id="${s.id}" class="secondary" ${hasSummary ? '' : 'disabled'}>View Summary</button>
          <button data-act="sumcopy" data-id="${s.id}" class="secondary" ${hasSummary ? '' : 'disabled'}>Copy .md</button>
          <button data-act="sumdl" data-id="${s.id}" class="secondary" ${hasSummary ? '' : 'disabled'}>Export .md</button>
        </div>

        <pre id="p-${s.id}" style="display:none;margin-top:10px" class="transcript small"></pre>
        <pre id="s-${s.id}" style="display:none;margin-top:10px" class="transcript small">${hasSummary ? (s.summary_md || '') : ''}</pre>
      `;
      historyEl.appendChild(div);
    });

    historyEl.querySelectorAll('button').forEach(btn=>{
      btn.onclick = async () => {
        const id = btn.getAttribute('data-id');
        const act = btn.getAttribute('data-act');
        const raw = localStorage.getItem(id);
        let s = null;
        try { s = JSON.parse(raw || '{}'); } catch {}
        if (!s) return;

        if (act==='view'){
          const pre = document.getElementById('p-'+id);
          pre.textContent = s.transcript || '';
          pre.style.display = pre.style.display==='none' ? 'block' : 'none';
        } else if (act==='copy'){
          navigator.clipboard.writeText(s.transcript || '');
          alert('Copied.');
        } else if (act==='dl'){
          const blob = new Blob([`[${s.timestamp}] (${fmtTime(s.duration_ms||0)})\n\n${s.transcript||''}`], {type:'text/plain'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `${(s.id||'session')}.txt`;
          a.click();
          URL.revokeObjectURL(a.href);
        } else if (act==='del'){
          localStorage.removeItem(id);
          // also remove from student index if present
          if (s.studentId){
            const key = `studentSessions-${s.studentId}`;
            try {
              const arr = JSON.parse(localStorage.getItem(key)||'[]').filter(x => x !== id);
              localStorage.setItem(key, JSON.stringify(arr));
            } catch {}
          }
          renderHistory();
        } else if (act==='sum'){
          await summarizeSessionById(id, btn);
        } else if (act==='sumview'){
          if (!s.summary_md) return;
          const pre = document.getElementById('s-'+id);
          pre.style.display = pre.style.display==='none' ? 'block' : 'none';
        } else if (act==='sumcopy'){
          if (!s.summary_md) return;
          await navigator.clipboard.writeText(s.summary_md);
          alert('Summary copied.');
        } else if (act==='sumdl'){
          if (!s.summary_md) return;
          const blob = new Blob([s.summary_md], {type:'text/markdown'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `${(s.id||'session')}-summary.md`;
          a.click();
          URL.revokeObjectURL(a.href);
        }
      };
    });
  }
  renderHistory();

  document.getElementById('clearAllBtn').onclick = () => {
    if (!confirm('Delete all saved sessions?')) return;
    const keys = [];
    for (let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i);
      if (k && (k.startsWith('session-') || k.startsWith('studentSessions-'))) keys.push(k);
    }
    keys.forEach(k=>localStorage.removeItem(k));
    renderHistory();
  };
</script>
</body>
</html>
